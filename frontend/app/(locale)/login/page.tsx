'use client'
import Loader from '@/components/Loader'
import { useLogin } from './useLogin'
import { useMutation } from '@tanstack/react-query'
import { useRouter } from 'next/navigation'
import api from '@/lib/axiosInstance'
import toast from 'react-hot-toast'
import { LoginPayload } from '@/app/types/types'
import { useAuth } from '@/hooks/useAuth'
import React from 'react'

export default function RegisterPage() {
    //TODO: redirect if logged in
    // const { data: authUser, status: loginStatus } = useAuth()

    const { state, setField } = useLogin()
    const { email, password, agree } = state
    const router = useRouter()

    const { mutate, isPending } = useMutation({
        mutationFn: async (payload: LoginPayload) => {
            const res = await api.post('/api/users/login', payload)
            return res.data
        },
        onSuccess: (user) => router.replace(`/profile/${user.username}`),
        onError: () => toast.error('Invalid email or password'),
    })

    if (isPending) return <Loader />

    const handleSubmit = (e: React.FormEvent) => {
        e.preventDefault()

        if (!email || !password) {
            toast.error('Please fill all fields & agree to terms')
            return
        }

        mutate({ email, password, agree })
    }

    return (
        <section className="_social_login_wrapper _layout_main_wrapper">
            <div className="_shape_one">
                <img src="/images/shape1.svg" alt="" className="_shape_img" />
                <img
                    src="/images/dark_shape.svg"
                    alt=""
                    className="_dark_shape"
                />
            </div>
            <div className="_shape_two">
                <img src="/images/shape2.svg" alt="" className="_shape_img" />
                <img
                    src="/images/dark_shape1.svg"
                    alt=""
                    className="_dark_shape _dark_shape_opacity"
                />
            </div>
            <div className="_shape_three">
                <img src="/images/shape3.svg" alt="" className="_shape_img" />
                <img
                    src="/images/dark_shape2.svg"
                    alt=""
                    className="_dark_shape _dark_shape_opacity"
                />
            </div>
            <div className="_social_login_wrap">
                <div className="container">
                    <div className="row align-items-center">
                        <div className="col-xl-8 col-lg-8 col-md-12 col-sm-12">
                            <div className="_social_login_left">
                                <div className="_social_login_left_image">
                                    <img
                                        src="/images/login.png"
                                        alt="Image"
                                        className="_left_img"
                                    />
                                </div>
                            </div>
                        </div>
                        <div className="col-xl-4 col-lg-4 col-md-12 col-sm-12">
                            <div className="_social_login_content">
                                <div className="_social_login_left_logo _mar_b28">
                                    <img
                                        src="/images/logo.svg"
                                        alt="Image"
                                        className="_left_logo"
                                    />
                                </div>
                                <p className="_social_login_content_para _mar_b8">
                                    Welcome back
                                </p>
                                <h4 className="_social_login_content_title _titl4 _mar_b50">
                                    Login to your account
                                </h4>
                                <button
                                    type="button"
                                    className="_social_login_content_btn _mar_b40"
                                >
                                    <img
                                        src="/images/google.svg"
                                        alt="Image"
                                        className="_google_img"
                                    />{' '}
                                    <span>Or sign-in with google</span>
                                </button>
                                <div className="_social_login_content_bottom_txt _mar_b40">
                                    {' '}
                                    <span>Or</span>
                                </div>
                                <form
                                    className="_social_login_form"
                                    onSubmit={handleSubmit}
                                >
                                    <div className="row">
                                        <div className="col-xl-12 col-lg-12 col-md-12 col-sm-12">
                                            <div className="_social_login_form_input _mar_b14">
                                                <label className="_social_login_label _mar_b8">
                                                    Email
                                                </label>
                                                <input
                                                    type="email"
                                                    className="form-control _social_login_input"
                                                    value={email}
                                                    onChange={(e) =>
                                                        setField(
                                                            'email',
                                                            e.target.value
                                                        )
                                                    }
                                                    required
                                                />
                                            </div>
                                        </div>
                                        <div className="col-xl-12 col-lg-12 col-md-12 col-sm-12">
                                            <div className="_social_login_form_input _mar_b14">
                                                <label className="_social_login_label _mar_b8">
                                                    Password
                                                </label>
                                                <input
                                                    type="password"
                                                    className="form-control _social_login_input"
                                                    value={password}
                                                    onChange={(e) =>
                                                        setField(
                                                            'password',
                                                            e.target.value
                                                        )
                                                    }
                                                    required
                                                />
                                            </div>
                                        </div>
                                    </div>
                                    <div className="row">
                                        <div className="col-lg-6 col-xl-6 col-md-6 col-sm-12">
                                            <div className="form-check _social_login_form_check">
                                                <input
                                                    className="form-check-input _social_login_form_check_input"
                                                    type="radio"
                                                    name="flexRadioDefault"
                                                    id="flexRadioDefault2"
                                                    defaultChecked
                                                />
                                                <label
                                                    className="form-check-label _social_login_form_check_label"
                                                    htmlFor="flexRadioDefault2"
                                                >
                                                    I agree to terms &
                                                    conditions
                                                </label>
                                            </div>
                                        </div>
                                        <div className="col-lg-6 col-xl-6 col-md-6 col-sm-12">
                                            <div className="_social_login_form_left">
                                                <p className="_social_login_form_left_para">
                                                    Forgot password?
                                                </p>
                                            </div>
                                        </div>
                                    </div>
                                    <div className="row">
                                        <div className="col-lg-12 col-md-12 col-xl-12 col-sm-12">
                                            <div className="_social_login_form_btn _mar_t40 _mar_b60">
                                                <button
                                                    type="submit"
                                                    className="_social_login_form_btn_link _btn1"
                                                    disabled={isPending}
                                                >
                                                    {isPending
                                                        ? 'Logging in...'
                                                        : 'Login now'}
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                </form>
                                <div className="row">
                                    <div className="col-xl-12 col-lg-12 col-md-12 col-sm-12">
                                        <div className="_social_login_bottom_txt">
                                            <p className="_social_login_bottom_txt_para">
                                                Dont have an account?{' '}
                                                <a href="/register">
                                                    Create New Account
                                                </a>
                                            </p>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </section>
    )
}
